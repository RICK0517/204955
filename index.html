<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>登入系統 Demo（含名稱 / 權限）</title>
  <style>
    :root { font-family: system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif; }
    body { margin:0; background:#0b0f16; color:#e8eefc; }
    .wrap { max-width:820px; margin:40px auto; padding:16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 1fr 1fr; } }
    .full { grid-column: 1 / -1; }
    .card { background:#111a2a; border:1px solid #1d2a44; border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size:18px; margin:0 0 12px; }
    h2 { font-size:15px; margin:0 0 10px; opacity:.95; }
    label { display:block; margin-top:10px; font-size:13px; opacity:.9; }
    input, select { width:100%; padding:10px; margin-top:4px; border-radius:10px;
      border:1px solid #2a3b61; background:#0b1324; color:#e8eefc; box-sizing:border-box; }
    select[multiple] { min-height:100px; }
    input:focus, select:focus { outline:none; border-color:#4b76ff; }
    button { padding:10px 14px; border-radius:10px; border:0; background:#4b76ff; color:white; cursor:pointer; font-weight:600; }
    button.secondary { background:#2a3b61; }
    button.danger { background:#ff4b6e; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .pill { border:1px solid #2a3b61; border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block; }
    .divider { height:1px; background:#1d2a44; margin:14px 0; }
    .msg { margin-top:10px; font-size:13px; }
    .msg.ok { color:#7CFFB2; }
    .msg.bad { color:#ff9ab0; }
    .hint { font-size:12px; opacity:.8; line-height:1.6; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .area-grid { display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    @media (min-width: 860px){ .area-grid { grid-template-columns: 1fr 1fr; } }
    .mini-card { border:1px solid #2a3b61; border-radius:12px; padding:10px; background:#0b1324; }
    .mini-card h3 { margin:0 0 8px; font-size:14px; }
    .mini-list { margin:6px 0 0; padding-left:18px; font-size:12px; opacity:.9; line-height:1.5; }
    .mini-title { font-size:12px; opacity:.8; margin-top:6px; }
  </style>
</head>
<body>
<div class="wrap">

  <!-- 登入 -->
  <div class="card" id="loginCard" hidden>
    <h1>登入</h1>
    <label for="loginUser">帳號</label>
    <input id="loginUser" autocomplete="username" />
    <label for="loginPass">密碼</label>
    <input id="loginPass" type="password" autocomplete="current-password" />
    <div class="row">
      <button id="btnLogin">登入</button>
      <button class="secondary" id="btnGotoInit">建立帳號</button>
    </div>
    <div class="hint" style="margin-top:10px;">
      Demo：資料保存在瀏覽器 localStorage，屬於明文保存，只適合練習/內測。
    </div>
    <div class="msg" id="loginMsg"></div>
  </div>

  <!-- 建立帳號 -->
  <div class="card" id="initCard" hidden>
    <h1>建立帳號</h1>
    <label for="initName">名稱（登入時不需要）</label>
    <input id="initName" placeholder="例如：王小明" />
    <label for="initUser">帳號（不可重複）</label>
    <input id="initUser" autocomplete="username" />
    <label for="initPass">密碼</label>
    <input id="initPass" type="password" autocomplete="new-password" />
    <label for="initRole">身分（建立後鎖定）</label>
    <select id="initRole">
      <option value="" disabled selected>請選擇</option>
      <option value="1">1 工程師</option>
      <option value="2">2 主管</option>
      <option value="3">3 員工</option>
    </select>
    <label for="initAreas">場域（可多選，建立帳號可略過）</label>
    <select id="initAreas" multiple></select>
    <div class="hint">提示：可按住 Ctrl / Command 進行多選。</div>
    <div class="row">
      <button id="btnInitSave">建立</button>
      <button class="secondary" id="btnInitBack">返回登入</button>
    </div>
    <div class="msg" id="initMsg"></div>
  </div>

  <!-- 登入後：主畫面 +（可選）管理區 -->
  <div id="panelArea" hidden>
    <div class="grid">

      <!-- 主畫面 -->
      <div class="card" id="dashboardCard">
        <div class="topbar">
          <h1 style="margin:0;">主畫面</h1>
          <div class="row" style="margin-top:0;">
            <button class="secondary" id="btnGotoEdit">修改我的帳號</button>
            <button class="secondary" id="btnOpenAccountMgmt" hidden>帳號管理</button>
            <button class="secondary" id="btnOpenAreaMgmt" hidden>場域管理</button>
          </div>
        </div>

        <div class="divider"></div>

        <div style="text-align:center;">
          <div style="opacity:.8; font-size:13px;">現在時間</div>
          <div id="clock" class="mono" style="font-size:36px; font-weight:800; margin-top:6px;">--:--:--</div>
          <div id="clockDate" style="opacity:.75; font-size:12px; margin-top:6px;"></div>
        </div>

        <div class="divider"></div>

        <div class="hint">
          名稱：<span class="mono" id="meNameShow"></span><br/>
          帳號：<span class="mono" id="meUserShow"></span><br/>
          身分：<span class="pill" id="meRoleShow"></span><br/>
          場域：<span class="mono" id="meAreasShow"></span>
        </div>

        <div class="divider"></div>
        <h2>我的場域資訊（最多顯示 5 個）</h2>
        <div class="area-grid" id="myAreaWidgets"></div>

        <div class="row">
          <button class="secondary" id="btnLogout">登出</button>
        </div>
        <div class="msg" id="dashMsg"></div>
      </div>

      <!-- 管理其他人：只給 工程師(1) / 主管(2) -->
      <div class="card full" id="adminCard" hidden>
        <div class="topbar">
          <h1 style="margin:0;">帳號管理</h1>
          <button class="secondary" id="btnBackFromAdmin">返回主畫面</button>
        </div>
        <div class="hint">
          工程師（1）/ 主管（2）可修改其他人的帳號與密碼；員工（3）不顯示此區。<br/>
          工程師可額外指派場域與刪除帳號。身分建立後鎖定，不提供修改。
        </div>

        <div class="divider"></div>

        <h2>修改他人的帳號 / 密碼</h2>
        <label for="otherSelect">使用者</label>
        <select id="otherSelect"></select>

        <label for="otherNameView">名稱（僅顯示）</label>
        <input id="otherNameView" disabled />

        <label for="otherUserEdit">帳號（不可重複）</label>
        <input id="otherUserEdit" />

        <label for="otherPassEdit">密碼</label>
        <input id="otherPassEdit" type="text" />

        <label for="otherAreasEdit">場域（僅工程師可編輯）</label>
        <select id="otherAreasEdit" multiple></select>
        <div class="hint">提示：可按住 Ctrl / Command 進行多選。</div>

        <div class="row">
          <button id="btnSaveOther">儲存</button>
          <button class="danger" id="btnDeleteOther" hidden>刪除帳號（僅工程師）</button>
        </div>

        <div class="divider"></div>

        <h2>建立新帳號</h2>
        <label for="newName">名稱</label>
        <input id="newName" placeholder="例如：陳大華" />

        <label for="newUser">帳號（不可重複）</label>
        <input id="newUser" />

        <label for="newPass">密碼</label>
        <input id="newPass" type="password" />

        <label for="newRole">身分（建立後鎖定）</label>
        <select id="newRole">
          <option value="" disabled selected>請選擇</option>
          <option value="1">1 工程師</option>
          <option value="2">2 主管</option>
          <option value="3">3 員工</option>
        </select>

        <label for="newAreas">場域（可多選，建立帳號可略過）</label>
        <select id="newAreas" multiple></select>
        <div class="hint">提示：可按住 Ctrl / Command 進行多選。</div>

        <div class="row">
          <button id="btnCreateUser">建立帳號</button>
        </div>

        <div class="msg" id="adminMsg"></div>
      </div>

      <!-- 場域管理：僅工程師(1) -->
      <div class="card full" id="areaCard" hidden>
        <div class="topbar">
          <h1 style="margin:0;">場域管理（僅工程師）</h1>
          <button class="secondary" id="btnBackFromArea">返回主畫面</button>
        </div>
        <div class="hint">場域管理已獨立於「建立新帳號」。僅工程師可新增、編輯、刪除場域。</div>

        <div class="divider"></div>

        <h2>新增場域</h2>
        <label for="newAreaName">場域名稱</label>
        <input id="newAreaName" placeholder="例如：台北廠" />
        <div class="row">
          <button id="btnAddArea">新增場域</button>
        </div>

        <div class="divider"></div>

        <h2>編輯 / 刪除場域</h2>
        <label for="areaSelect">選擇場域</label>
        <select id="areaSelect"></select>

        <label for="editAreaName">新名稱</label>
        <input id="editAreaName" placeholder="輸入新名稱" />

        <div class="row">
          <button id="btnRenameArea">儲存名稱</button>
          <button class="danger" id="btnDeleteArea">刪除場域</button>
        </div>

        <div class="msg" id="areaMsg"></div>
      </div>

      <!-- 修改自己帳密（由「修改」進入） -->
      <div class="card full" id="editCard" hidden>
        <div class="topbar">
          <h1 style="margin:0;">修改自己的帳號 / 密碼</h1>
          <button class="secondary" id="btnBackDashboard">返回</button>
        </div>

        <div class="divider"></div>

        <div class="hint">名稱建立時輸入（登入不需要）。此頁只提供修改帳號與密碼。</div>

        <label for="meUserEdit">帳號（不可重複）</label>
        <input id="meUserEdit" />

        <label for="mePassEdit">密碼</label>
        <input id="mePassEdit" type="text" />

        <div class="row">
          <button id="btnSaveMe">儲存</button>
        </div>

        <div class="msg" id="meMsg"></div>
      </div>

      <!-- 重置 -->
      <div class="card full">
        <h2>儲存後台設定</h2>
        <label for="backendBaseUrl">後台 API Base URL</label>
        <input id="backendBaseUrl" placeholder="例如：http://localhost:8080" />

        <label for="backendToken">API Token（選填）</label>
        <input id="backendToken" placeholder="例如：Bearer xxxxx" />

        <div class="row">
          <button id="btnSaveBackendConfig">儲存後台設定</button>
          <button class="secondary" id="btnSyncBackend">同步目前資料到後台</button>
        </div>
        <div class="hint">說明：會將 users / areas / areaData 送到 <span class="mono">POST /api/sync</span>。</div>
        <div class="msg" id="backendMsg"></div>
      </div>

      <!-- 重置 -->
      <div class="card full">
        <h2>重置（清空所有資料）</h2>
        <div class="row">
          <button class="danger" id="btnResetAll">清除 localStorage 並重新開始</button>
        </div>
        <div class="msg" id="resetMsg"></div>
      </div>

    </div>
  </div>
</div>

<script>
(() => {
  const K = {
    users: "demo_users_v2",      // [{id, name, username, password, role, areas, createdAt, updatedAt}]
    areas: "demo_areas_v1",      // ["北區", "南區", ...]
    areaData: "demo_area_data_v1", // { [areaName]: { weather, handover, staff } }
    session: "demo_session_v2",  // { userId }
    backend: "demo_backend_config_v1" // { baseUrl, token }
  };
  const DEFAULT_AREAS = ["北區", "中區", "南區", "東區", "西區", "南二區"];
  const DEFAULT_AREA_DATA = {
    "北區": { weather: "多雲 27°C", handover: ["巡檢已完成", "門禁卡機異常待維修"], staff: ["王小明", "陳美玲", "李大華"] },
    "中區": { weather: "晴天 30°C", handover: ["倉儲盤點中", "下午 3 點消防演練"], staff: ["林佳宏", "張雅婷", "鄭志明"] },
    "南區": { weather: "短暫陣雨 26°C", handover: ["A 線保養完成", "B 線請注意地面濕滑"], staff: ["黃建國", "何佩珊", "郭秉宸"] },
    "東區": { weather: "陰天 25°C", handover: ["冷氣保養排程中", "夜班提前 30 分鐘交接"], staff: ["呂家豪", "宋怡君", "蔡宗翰"] },
    "西區": { weather: "晴時多雲 29°C", handover: ["出貨正常", "大門監視器已復原"], staff: ["吳孟哲", "劉佳蓉", "楊子儀"] },
    "南二區": { weather: "多雲偶雨 27°C", handover: ["清潔外包已進場", "訪客動線已更新"], staff: ["周庭安", "蘇怡文", "許家瑋"] }
  };
  const $ = (id) => document.getElementById(id);
  const nowISO = () => new Date().toISOString();
  const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : (Date.now() + "_" + Math.random().toString(16).slice(2)));

  function roleText(v){
    switch(String(v)){
      case "1": return "1 工程師";
      case "2": return "2 主管";
      case "3": return "3 員工";
      default: return "未設定";
    }
  }
  function canManageOthers(role){
    return String(role) === "1" || String(role) === "2";
  }
  function isEngineer(role){
    return String(role) === "1";
  }

  function setMsg(el, text, ok=true){
    el.textContent = text;
    el.className = "msg " + (ok ? "ok" : "bad");
  }

  function loadUsers(){
    try { return JSON.parse(localStorage.getItem(K.users) || "[]"); }
    catch { return []; }
  }

  function loadBackendConfig(){
    try {
      const config = JSON.parse(localStorage.getItem(K.backend) || "null");
      return {
        baseUrl: String(config?.baseUrl || "").trim(),
        token: String(config?.token || "").trim()
      };
    } catch {
      return { baseUrl: "", token: "" };
    }
  }
  function saveBackendConfig(config){
    localStorage.setItem(K.backend, JSON.stringify({
      baseUrl: String(config?.baseUrl || "").trim(),
      token: String(config?.token || "").trim()
    }));
  }
  function saveUsers(users){
    localStorage.setItem(K.users, JSON.stringify(users));
  }


  function loadAreas(){
    try {
      const arr = JSON.parse(localStorage.getItem(K.areas) || "null");
      if (Array.isArray(arr)) return normalizeAreas(arr);
      return [...DEFAULT_AREAS];
    } catch {
      return [...DEFAULT_AREAS];
    }
  }
  function saveAreas(areas){
    localStorage.setItem(K.areas, JSON.stringify(normalizeAreas(areas)));
  }
  function loadAreaData(){
    try {
      const obj = JSON.parse(localStorage.getItem(K.areaData) || "null");
      if (obj && typeof obj === "object") return normalizeAreaData(obj);
      return normalizeAreaData(DEFAULT_AREA_DATA);
    } catch {
      return normalizeAreaData(DEFAULT_AREA_DATA);
    }
  }
  function saveAreaData(areaData){
    localStorage.setItem(K.areaData, JSON.stringify(normalizeAreaData(areaData)));
  }
  function normalizeAreaData(areaData){
    const output = {};
    for (const [name, info] of Object.entries(areaData || {})){
      const key = String(name || "").trim();
      if (!key) continue;
      output[key] = {
        weather: String(info?.weather || "待更新"),
        handover: Array.isArray(info?.handover) ? info.handover.map(v => String(v || "").trim()).filter(Boolean) : [],
        staff: Array.isArray(info?.staff) ? info.staff.map(v => String(v || "").trim()).filter(Boolean) : []
      };
    }
    return output;
  }
  function ensureAreaDataForAreas(areas, areaData){
    const merged = { ...normalizeAreaData(DEFAULT_AREA_DATA), ...normalizeAreaData(areaData) };
    for (const area of normalizeAreas(areas)){
      if (!merged[area]){
        merged[area] = { weather: "待更新", handover: ["尚無交接事項"], staff: ["尚無排班資料"] };
      }
    }
    return merged;
  }
  function normalizeAreas(areas){
    return [...new Set((areas || []).map(v => String(v || "").trim()).filter(Boolean))];
  }
  function getSelectedValues(selectEl){
    return Array.from(selectEl.selectedOptions || []).map(opt => opt.value);
  }
  function renderAreaOptions(selectId, areas, selected = []){
    const sel = $(selectId);
    if (!sel) return;
    const selectedSet = new Set(selected);
    sel.innerHTML = "";
    for (const area of areas){
      const opt = document.createElement("option");
      opt.value = area;
      opt.textContent = area;
      if (selectedSet.has(area)) opt.selected = true;
      sel.appendChild(opt);
    }
  }

  function getSession(){
    try { return JSON.parse(localStorage.getItem(K.session) || "null"); }
    catch { return null; }
  }
  function setSession(userId){
    localStorage.setItem(K.session, JSON.stringify({ userId }));
  }
  function clearSession(){
    localStorage.removeItem(K.session);
  }

  function findUserById(users, id){
    return users.find(u => u.id === id) || null;
  }
  function findUserByUsername(users, username){
    return users.find(u => u.username === username) || null;
  }

  function showOnly(which){
    $("loginCard").hidden = which !== "login";
    $("initCard").hidden  = which !== "init";
    const inPanel = ["panel", "edit", "admin", "area"].includes(which);
    $("panelArea").hidden = !inPanel;

    $("dashboardCard").hidden = which !== "panel";
    $("editCard").hidden  = which !== "edit";
    $("adminCard").hidden = which !== "admin";
    $("areaCard").hidden = which !== "area";
  }

  // ----- Clock -----
  let clockTimer = null;
  function startClock(){
    if (clockTimer) return; // avoid multiple timers
    const clockEl = $("clock");
    const dateEl = $("clockDate");
    if (!clockEl) return;

    const tick = () => {
      const d = new Date();
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      const s = String(d.getSeconds()).padStart(2, "0");
      clockEl.textContent = `${h}:${m}:${s}`;
      dateEl.textContent = d.toLocaleDateString("zh-Hant", { year:"numeric", month:"2-digit", day:"2-digit", weekday:"short" });
    };
    tick();
    clockTimer = setInterval(tick, 1000);
  }
  function stopClock(){
    if (!clockTimer) return;
    clearInterval(clockTimer);
    clockTimer = null;
  }

  function renderDashboardAreaData(myAreas, areaData){
    const host = $("myAreaWidgets");
    if (!host) return;
    host.innerHTML = "";

    const picked = normalizeAreas(myAreas).slice(0, 5);
    if (picked.length === 0){
      const empty = document.createElement("div");
      empty.className = "mini-card";
      empty.textContent = "尚未指派場域，請由工程師設定。";
      host.appendChild(empty);
      return;
    }

    for (const area of picked){
      const info = areaData[area] || { weather: "待更新", handover: ["尚無交接事項"], staff: ["尚無排班資料"] };
      const card = document.createElement("div");
      card.className = "mini-card";
      card.innerHTML = `
        <h3>${area}</h3>
        <div class="mini-title">1 天氣格</div>
        <div>${info.weather || "待更新"}</div>
        <div class="mini-title">2 交接事項</div>
        <ul class="mini-list">${(info.handover?.length ? info.handover : ["尚無交接事項"]).map(v => `<li>${v}</li>`).join("")}</ul>
        <div class="mini-title">3 今日上班名單</div>
        <ul class="mini-list">${(info.staff?.length ? info.staff : ["尚無排班資料"]).map(v => `<li>${v}</li>`).join("")}</ul>
      `;
      host.appendChild(card);
    }
  }

  function refreshPanel(){
    const users = loadUsers();
    const areas = loadAreas();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;

    if (!me){
      clearSession();
      stopClock();
      showOnly(users.length ? "login" : "init");
      return;
    }

    // dashboard show
    const areaData = ensureAreaDataForAreas(areas, loadAreaData());
    saveAreaData(areaData);
    const myAreas = normalizeAreas(me.areas || []);
    const shownAreas = myAreas.slice(0, 5);

    $("meNameShow").textContent = me.name || "";
    $("meUserShow").textContent = me.username || "";
    $("meRoleShow").textContent = roleText(me.role);
    $("meAreasShow").textContent = shownAreas.join("、") || "未設定";
    if (myAreas.length > 5) {
      $("meAreasShow").textContent += "（僅顯示前 5 個）";
    }
    renderDashboardAreaData(myAreas, areaData);

    // edit self fields
    $("meUserEdit").value = me.username || "";
    $("mePassEdit").value = me.password || "";

    // admin / area entry buttons visibility
    const okAdmin = canManageOthers(me.role);
    const canManageArea = isEngineer(me.role);
    $("btnOpenAccountMgmt").hidden = !okAdmin;
    $("btnOpenAreaMgmt").hidden = !canManageArea;
    $("btnDeleteOther").hidden = !isEngineer(me.role);

    if (okAdmin){
      renderAreaOptions("newAreas", areas);
      // Populate other users select (exclude me)
      const others = users.filter(u => u.id !== me.id);
      const sel = $("otherSelect");
      sel.innerHTML = "";

      if (others.length === 0){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "（目前沒有其他帳號）";
        sel.appendChild(opt);
        $("otherNameView").value = "";
        $("otherUserEdit").value = "";
        $("otherPassEdit").value = "";
        renderAreaOptions("otherAreasEdit", areas, []);
      } else {
        for (const u of others){
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = `${u.name || "(未命名)"} / ${u.username} / ${roleText(u.role)}`;
          sel.appendChild(opt);
        }
        sel.value = others[0].id;
        $("otherNameView").value = others[0].name || "";
        $("otherUserEdit").value = others[0].username || "";
        $("otherPassEdit").value = others[0].password || "";
        renderAreaOptions("otherAreasEdit", areas, others[0].areas || []);
      }
      $("otherAreasEdit").disabled = !isEngineer(me.role);
    }

    if (canManageArea){
      refreshAreaManager(areas);
    }

    const backend = loadBackendConfig();
    $("backendBaseUrl").value = backend.baseUrl;
    $("backendToken").value = backend.token;
  }

  function refreshAreaManager(areas = loadAreas()){
    const areaSel = $("areaSelect");
    const current = areaSel.value;
    areaSel.innerHTML = "";

    if (areas.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "（尚無場域）";
      areaSel.appendChild(opt);
      $("editAreaName").value = "";
      return;
    }

    for (const area of areas){
      const opt = document.createElement("option");
      opt.value = area;
      opt.textContent = area;
      areaSel.appendChild(opt);
    }

    areaSel.value = areas.includes(current) ? current : areas[0];
    $("editAreaName").value = areaSel.value;
  }

  // ----- boot routing -----
  (function boot(){
    const users = loadUsers();
    const savedAreas = loadAreas();
    const areaData = ensureAreaDataForAreas(savedAreas, loadAreaData());
    saveAreas(savedAreas);
    saveAreaData(areaData);
    renderAreaOptions("initAreas", savedAreas);
    renderAreaOptions("newAreas", savedAreas);
    refreshAreaManager(savedAreas);
    const sess = getSession();
    const backend = loadBackendConfig();
    $("backendBaseUrl").value = backend.baseUrl;
    $("backendToken").value = backend.token;

    if (users.length === 0){
      showOnly("init");
      return;
    }

    const me = sess?.userId ? findUserById(users, sess.userId) : null;
    if (me){
      showOnly("panel");
      refreshPanel();
    renderHandoverPanelList();
      startClock();
      return;
    }

    showOnly("login");
  })();

  // ===== init / create account =====
  $("btnGotoInit").addEventListener("click", () => {
    renderAreaOptions("initAreas", loadAreas());
    showOnly("init");
  });
  $("btnInitBack").addEventListener("click", () => showOnly("login"));

  $("btnInitSave").addEventListener("click", () => {
    const name = $("initName").value.trim();
    const username = $("initUser").value.trim();
    const password = $("initPass").value;
    const role = $("initRole").value;
    const selectedAreas = getSelectedValues($("initAreas"));

    if (!name) return setMsg($("initMsg"), "名稱要填。", false);
    if (!username || !password) return setMsg($("initMsg"), "帳號與密碼都要填。", false);
    if (!role) return setMsg($("initMsg"), "身分一定要選，建立後鎖定。", false);

    const users = loadUsers();
    if (findUserByUsername(users, username)) return setMsg($("initMsg"), "帳號已存在。", false);

    users.push({
      id: uuid(),
      name,
      username,
      password,
      role: String(role),
      areas: selectedAreas,
      createdAt: nowISO(),
      updatedAt: nowISO()
    });
    saveUsers(users);

    setMsg($("initMsg"), "建立完成，請登入。", true);
    showOnly("login");
    $("loginUser").value = username;
    $("loginPass").value = "";
  });

  // ===== login =====
  $("btnLogin").addEventListener("click", () => {
    const username = $("loginUser").value.trim();
    const password = $("loginPass").value;

    const users = loadUsers();
    const me = findUserByUsername(users, username);

    if (!me || me.password !== password){
      return setMsg($("loginMsg"), "帳號或密碼錯誤。", false);
    }

    setSession(me.id);
    showOnly("panel");
    refreshPanel();
    startClock();
    setMsg($("dashMsg"), "登入成功。", true);
  });

  // ===== dashboard -> edit =====
  $("btnGotoEdit").addEventListener("click", () => {
    showOnly("edit");
    $("meMsg").textContent = "";
  });

  $("btnBackDashboard").addEventListener("click", () => {
    showOnly("panel");
  });

  $("btnOpenAccountMgmt").addEventListener("click", () => {
    showOnly("admin");
    $("adminMsg").textContent = "";
  });

  $("btnOpenAreaMgmt").addEventListener("click", () => {
    showOnly("area");
    $("areaMsg").textContent = "";
  });

  $("btnBackFromAdmin").addEventListener("click", () => showOnly("panel"));
  $("btnBackFromArea").addEventListener("click", () => showOnly("panel"));

  // ===== save self =====
  $("btnSaveMe").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me) return;

    const newUser = $("meUserEdit").value.trim();
    const newPass = $("mePassEdit").value;

    if (!newUser || !newPass) return setMsg($("meMsg"), "帳號與密碼都要填。", false);

    const conflict = users.find(u => u.username === newUser && u.id !== me.id);
    if (conflict) return setMsg($("meMsg"), "帳號已被其他人使用。", false);

    me.username = newUser;
    me.password = newPass;
    me.updatedAt = nowISO();

    saveUsers(users);
    refreshPanel();
    setMsg($("meMsg"), "已儲存。", true);
  });

  // ===== admin select other =====
  $("otherSelect").addEventListener("change", () => {
    const users = loadUsers();
    const id = $("otherSelect").value;
    const u = findUserById(users, id);
    if (!u){
      $("otherNameView").value = "";
      $("otherUserEdit").value = "";
      $("otherPassEdit").value = "";
      return;
    }
    $("otherNameView").value = u.name || "";
    $("otherUserEdit").value = u.username || "";
    $("otherPassEdit").value = u.password || "";
    renderAreaOptions("otherAreasEdit", loadAreas(), u.areas || []);
  });

  // ===== admin save other =====
  $("btnSaveOther").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || !canManageOthers(me.role)) return;

    const targetId = $("otherSelect").value;
    const target = findUserById(users, targetId);
    if (!target) return setMsg($("adminMsg"), "沒有可修改的目標。", false);

    const newUser = $("otherUserEdit").value.trim();
    const newPass = $("otherPassEdit").value;

    if (!newUser || !newPass) return setMsg($("adminMsg"), "帳號與密碼都要填。", false);

    const conflict = users.find(u => u.username === newUser && u.id !== target.id);
    if (conflict) return setMsg($("adminMsg"), "帳號已被其他人使用。", false);

    target.username = newUser;
    target.password = newPass;
    if (isEngineer(me.role)) {
      target.areas = getSelectedValues($("otherAreasEdit"));
    }
    target.updatedAt = nowISO();

    saveUsers(users);
    refreshPanel();
    setMsg($("adminMsg"), "已更新該使用者帳密。", true);
  });

  // ===== admin create new user =====
  $("btnCreateUser").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || !canManageOthers(me.role)) return;

    const name = $("newName").value.trim();
    const username = $("newUser").value.trim();
    const password = $("newPass").value;
    const role = $("newRole").value;
    const selectedAreas = getSelectedValues($("newAreas"));

    if (!name) return setMsg($("adminMsg"), "名稱要填。", false);
    if (!username || !password) return setMsg($("adminMsg"), "新帳號與密碼都要填。", false);
    if (!role) return setMsg($("adminMsg"), "新帳號身分一定要選。", false);
    if (findUserByUsername(users, username)) return setMsg($("adminMsg"), "帳號已存在。", false);

    users.push({
      id: uuid(),
      name,
      username,
      password,
      role: String(role),
      areas: selectedAreas,
      createdAt: nowISO(),
      updatedAt: nowISO()
    });
    saveUsers(users);

    $("newName").value = "";
    $("newUser").value = "";
    $("newPass").value = "";
    $("newRole").value = "";
    renderAreaOptions("newAreas", loadAreas());

    refreshPanel();
    setMsg($("adminMsg"), "已建立新帳號。", true);
  });


  // ===== engineer delete user =====
  $("btnDeleteOther").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || !isEngineer(me.role)) return;

    const targetId = $("otherSelect").value;
    const target = findUserById(users, targetId);
    if (!target) return setMsg($("adminMsg"), "沒有可刪除的目標。", false);

    const nextUsers = users.filter(u => u.id !== target.id);
    saveUsers(nextUsers);
    refreshPanel();
    setMsg($("adminMsg"), "已刪除該帳號。", true);
  });


  // ===== engineer add area =====
  $("btnAddArea").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || String(me.role) !== "1") return;

    const areaName = $("newAreaName").value.trim();
    if (!areaName) return setMsg($("areaMsg"), "場域名稱要填。", false);

    const areas = loadAreas();
    if (areas.includes(areaName)) return setMsg($("areaMsg"), "場域已存在。", false);

    areas.push(areaName);
    const areaData = ensureAreaDataForAreas(areas, loadAreaData());
    saveAreas(areas);
    saveAreaData(areaData);
    renderAreaOptions("newAreas", areas);
    renderAreaOptions("initAreas", areas);
    refreshAreaManager(areas);
    $("newAreaName").value = "";
    setMsg($("areaMsg"), "已新增場域。", true);
  });

  $("areaSelect").addEventListener("change", () => {
    $("editAreaName").value = $("areaSelect").value;
  });

  $("btnRenameArea").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || String(me.role) !== "1") return;

    const oldName = $("areaSelect").value;
    const newName = $("editAreaName").value.trim();
    if (!oldName) return setMsg($("areaMsg"), "沒有可編輯的場域。", false);
    if (!newName) return setMsg($("areaMsg"), "新名稱要填。", false);

    const areas = loadAreas();
    if (!areas.includes(oldName)) return setMsg($("areaMsg"), "原場域不存在。", false);
    if (oldName !== newName && areas.includes(newName)) return setMsg($("areaMsg"), "新名稱已存在。", false);

    const idx = areas.indexOf(oldName);
    areas[idx] = newName;

    const areaData = loadAreaData();
    if (areaData[oldName]){
      areaData[newName] = areaData[oldName];
      delete areaData[oldName];
    }

    for (const u of users){
      if (!Array.isArray(u.areas)) continue;
      u.areas = u.areas.map(a => (a === oldName ? newName : a));
      u.updatedAt = nowISO();
    }

    saveAreas(areas);
    saveAreaData(ensureAreaDataForAreas(areas, areaData));
    saveUsers(users);
    renderAreaOptions("newAreas", areas);
    renderAreaOptions("initAreas", areas);
    refreshPanel();
    setMsg($("areaMsg"), "已更新場域名稱。", true);
  });

  $("btnDeleteArea").addEventListener("click", () => {
    const users = loadUsers();
    const sess = getSession();
    const me = sess ? findUserById(users, sess.userId) : null;
    if (!me || String(me.role) !== "1") return;

    const areaName = $("areaSelect").value;
    if (!areaName) return setMsg($("areaMsg"), "沒有可刪除的場域。", false);

    const usedBy = users.filter(u => (u.areas || []).includes(areaName));
    if (usedBy.length > 0){
      return setMsg($("areaMsg"), "此場域仍有使用者綁定，無法刪除。", false);
    }

    const areas = loadAreas().filter(a => a !== areaName);
    const areaData = loadAreaData();
    delete areaData[areaName];
    saveAreas(areas);
    saveAreaData(ensureAreaDataForAreas(areas, areaData));
    renderAreaOptions("newAreas", areas);
    renderAreaOptions("initAreas", areas);
    refreshAreaManager(areas);
    setMsg($("areaMsg"), "已刪除場域。", true);
  });

  // ===== logout =====
  $("btnLogout").addEventListener("click", () => {
    clearSession();
    stopClock();
    showOnly("login");
    setMsg($("loginMsg"), "已登出。", true);
  });

  // ===== reset =====
  $("btnResetAll").addEventListener("click", () => {
    localStorage.removeItem(K.users);
    localStorage.removeItem(K.session);
    localStorage.removeItem(K.areas);
    localStorage.removeItem(K.areaData);
    stopClock();
    showOnly("init");
    setMsg($("resetMsg"), "已清空，請重新建立帳號。", true);
  });

  // ===== backend sync =====
  $("btnSaveBackendConfig").addEventListener("click", () => {
    const baseUrl = $("backendBaseUrl").value.trim().replace(/\/$/, "");
    const token = $("backendToken").value.trim();
    saveBackendConfig({ baseUrl, token });
    setMsg($("backendMsg"), "後台設定已儲存。", true);
  });

  $("btnSyncBackend").addEventListener("click", async () => {
    const config = loadBackendConfig();
    if (!config.baseUrl){
      return setMsg($("backendMsg"), "請先填入後台 API Base URL。", false);
    }

    const payload = {
      users: loadUsers(),
      areas: loadAreas(),
      areaData: loadAreaData(),
      syncedAt: nowISO()
    };

    const headers = { "Content-Type": "application/json" };
    if (config.token){
      headers.Authorization = config.token;
    }

    try {
      const res = await fetch(`${config.baseUrl}/api/sync`, {
        method: "POST",
        headers,
        body: JSON.stringify(payload)
      });

      if (!res.ok){
        const text = await res.text();
        return setMsg($("backendMsg"), `同步失敗（${res.status}）：${text || "請檢查後台"}`, false);
      }

      setMsg($("backendMsg"), "已成功同步到後台。", true);
    } catch (err) {
      setMsg($("backendMsg"), `無法連線到後台：${err?.message || "未知錯誤"}`, false);
    }
  });
})();
</script>
</body>
</html>
